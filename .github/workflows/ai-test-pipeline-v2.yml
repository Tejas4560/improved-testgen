name: AI Test Generation Pipeline V2

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'Target repository URL (leave empty to auto-detect)'
        required: false
        default: ''
        type: string
      repo_branch:
        description: 'Branch to test (leave empty to auto-detect)'
        required: false
        default: ''
        type: string
      min_coverage:
        description: 'Minimum coverage threshold (%)'
        required: false
        default: '90'
        type: string
      delta_threshold:
        description: 'Minimum coverage improvement required (pp)'
        required: false
        default: '0'
        type: string
      deploy_pages:
        description: 'Deploy coverage report to GitHub Pages'
        required: false
        default: 'true'
        type: string
      sonar_project_key:
        description: 'SonarQube Project Key (optional)'
        required: false
        default: ''
        type: string
      auto_push_tests:
        description: 'Auto-push generated tests to a dedicated branch'
        required: false
        default: 'false'
        type: string
      tests_branch:
        description: 'Branch name for generated tests (default: ai-generated-tests)'
        required: false
        default: 'ai-generated-tests'
        type: string

  workflow_call:
    inputs:
      repo_url:
        description: 'Target repository URL'
        required: false
        default: ''
        type: string
      repo_branch:
        description: 'Branch to test'
        required: false
        default: ''
        type: string
      min_coverage:
        description: 'Minimum coverage threshold (%)'
        required: false
        default: '90'
        type: string
      delta_threshold:
        description: 'Minimum coverage improvement required (pp)'
        required: false
        default: '0'
        type: string
      deploy_pages:
        description: 'Deploy coverage report to GitHub Pages'
        required: false
        default: 'true'
        type: string
      sonar_project_key:
        description: 'SonarQube Project Key'
        required: false
        default: ''
        type: string
      auto_push_tests:
        description: 'Auto-push generated tests to a dedicated branch'
        required: false
        default: 'false'
        type: string
      tests_branch:
        description: 'Branch name for generated tests'
        required: false
        default: 'ai-generated-tests'
        type: string

    secrets:
      AZURE_OPENAI_API_KEY:
        required: true
      AZURE_OPENAI_ENDPOINT:
        required: true
      AZURE_OPENAI_DEPLOYMENT:
        required: true
      AZURE_OPENAI_API_VERSION:
        required: false
      SONAR_HOST_URL:
        required: false
      SONAR_TOKEN:
        required: false
      GIT_PUSH_TOKEN:
        required: false

    outputs:
      coverage_before:
        description: 'Coverage before AI test generation'
        value: ${{ jobs.test-generation.outputs.coverage_before }}
      coverage_after:
        description: 'Coverage after AI test generation'
        value: ${{ jobs.test-generation.outputs.coverage_after }}
      coverage_delta:
        description: 'Coverage improvement (percentage points)'
        value: ${{ jobs.test-generation.outputs.coverage_delta }}
      tests_generated:
        description: 'Number of test files generated'
        value: ${{ jobs.test-generation.outputs.tests_generated }}
      tests_passed:
        description: 'Number of tests passed'
        value: ${{ jobs.test-generation.outputs.tests_passed }}
      tests_failed:
        description: 'Number of tests failed'
        value: ${{ jobs.test-generation.outputs.tests_failed }}
      pipeline_status:
        description: 'Pipeline status (success/failed)'
        value: ${{ jobs.test-generation.outputs.pipeline_status }}
      coverage_report_url:
        description: 'GitHub Pages URL for coverage report'
        value: ${{ jobs.test-generation.outputs.coverage_report_url }}
      threshold_passed:
        description: 'Whether coverage threshold was met'
        value: ${{ jobs.test-generation.outputs.threshold_passed }}
      delta_passed:
        description: 'Whether delta threshold was met'
        value: ${{ jobs.test-generation.outputs.delta_passed }}
      tests_branch_url:
        description: 'URL of the branch containing generated tests'
        value: ${{ jobs.test-generation.outputs.tests_branch_url }}

  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened]

env:
  PYTHON_VERSION: '3.10'
  PIPELINE_REPO: 'Tejas4560/improved-testgen'
  PIPELINE_BRANCH: 'T1'
  GENERATION_TIMEOUT: '600'
  OPENAI_TIMEOUT: '120'
  OPENAI_REQUEST_TIMEOUT: '180'

jobs:
  test-generation:
    name: AI Test Generation
    runs-on: ubuntu-latest
    timeout-minutes: 60

    permissions:
      contents: write
      pages: write
      id-token: write
      pull-requests: write

    outputs:
      coverage_before: ${{ steps.metrics.outputs.coverage_before }}
      coverage_after: ${{ steps.metrics.outputs.coverage_after }}
      coverage_delta: ${{ steps.metrics.outputs.coverage_delta }}
      tests_generated: ${{ steps.metrics.outputs.tests_generated }}
      tests_passed: ${{ steps.metrics.outputs.tests_passed }}
      tests_failed: ${{ steps.metrics.outputs.tests_failed }}
      pipeline_status: ${{ steps.metrics.outputs.pipeline_status }}
      coverage_report_url: ${{ steps.deploy-pages.outputs.pages_url }}
      threshold_passed: ${{ steps.metrics.outputs.threshold_passed }}
      delta_passed: ${{ steps.metrics.outputs.delta_passed }}
      tests_branch_url: ${{ steps.push-tests.outputs.tests_branch_url }}

    steps:
      - name: Checkout Pipeline Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PIPELINE_REPO }}
          ref: ${{ env.PIPELINE_BRANCH }}
          path: pipeline

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Detect Target Repository
        id: detect-repo
        run: |
          echo "Detecting target repository..."

          REPO_URL="${{ inputs.repo_url }}"
          if [ -z "$REPO_URL" ]; then
            REPO_URL="https://github.com/${{ github.repository }}.git"
            echo "Auto-detected repo: $REPO_URL"
          fi

          REPO_BRANCH="${{ inputs.repo_branch }}"
          if [ -z "$REPO_BRANCH" ]; then
            if [ -n "${{ github.head_ref }}" ]; then
              REPO_BRANCH="${{ github.head_ref }}"
            elif [ -n "${{ github.ref_name }}" ]; then
              REPO_BRANCH="${{ github.ref_name }}"
            else
              REPO_BRANCH="main"
            fi
            echo "Auto-detected branch: $REPO_BRANCH"
          fi

          REPO_NAME=$(echo "$REPO_URL" | sed 's/.*\///' | sed 's/\.git$//')

          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "repo_branch=$REPO_BRANCH" >> $GITHUB_OUTPUT
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "Target: $REPO_NAME @ $REPO_BRANCH"

      - name: Clone Target Repository
        run: |
          echo "Cloning ${{ steps.detect-repo.outputs.repo_name }}..."
          cd ${{ github.workspace }}/pipeline
          # Full clone (not shallow) to match v1 behavior
          git clone --branch "${{ steps.detect-repo.outputs.repo_branch }}" "${{ steps.detect-repo.outputs.repo_url }}" target_repo
          echo "Target repository structure:"
          ls -la target_repo/
          PY_COUNT=$(find target_repo -name "*.py" -type f | wc -l)
          echo "Found $PY_COUNT Python files"

      - name: Install Pipeline Dependencies
        run: |
          cd ${{ github.workspace }}/pipeline
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov pytest-json-report coverage

      - name: Install Target Project Dependencies
        run: |
          cd ${{ github.workspace }}/pipeline
          source venv/bin/activate
          # Skip this step - let pipeline_runner.sh handle dependency installation
          # This avoids double-installation issues and ensures consistent behavior with v1
          echo "Skipping pre-installation (handled by pipeline_runner.sh)"
          if [ -f target_repo/requirements.txt ]; then
            echo "Target project has requirements.txt - will be installed by pipeline"
          fi

      - name: Measure Initial Coverage
        id: coverage-before
        run: |
          cd ${{ github.workspace }}/pipeline
          source venv/bin/activate
          echo "Measuring initial coverage (manual tests)..."

          COVERAGE_BEFORE="0"
          MANUAL_TESTS_FOUND="false"

          if find target_repo -name "test_*.py" -o -name "*_test.py" 2>/dev/null | head -1 | grep -q .; then
            MANUAL_TESTS_FOUND="true"
            echo "Found existing test files"
            cd target_repo
            PYTHONPATH=. python -m pytest --cov=. --cov-report=xml:coverage_before.xml --cov-report=term --ignore=venv --ignore=.venv -q 2>/dev/null || true
            if [ -f coverage_before.xml ]; then
              COVERAGE_BEFORE=$(python3 -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage_before.xml'); root = tree.getroot(); rate = float(root.attrib.get('line-rate', 0)); print(f'{rate * 100:.2f}')" 2>/dev/null || echo "0")
              cp coverage_before.xml ${{ github.workspace }}/pipeline/
            fi
            cd ..
          else
            echo "No existing tests found"
          fi

          echo "coverage_before=$COVERAGE_BEFORE" >> $GITHUB_OUTPUT
          echo "manual_tests_found=$MANUAL_TESTS_FOUND" >> $GITHUB_OUTPUT
          echo "Initial coverage: ${COVERAGE_BEFORE}%"

      - name: Run AI Test Generation Pipeline
        id: run-pipeline
        env:
          TARGET_ROOT: ${{ github.workspace }}/pipeline/target_repo
          PYTHONPATH: ${{ github.workspace }}/pipeline/target_repo
          MIN_COVERAGE_THRESHOLD: ${{ inputs.min_coverage || '90' }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION || '2024-02-15-preview' }}
          GENERATION_TIMEOUT: ${{ env.GENERATION_TIMEOUT }}
          OPENAI_TIMEOUT: ${{ env.OPENAI_TIMEOUT }}
          OPENAI_REQUEST_TIMEOUT: ${{ env.OPENAI_REQUEST_TIMEOUT }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ inputs.sonar_project_key }}
          GIT_PUSH_TOKEN: ${{ secrets.GIT_PUSH_TOKEN }}
        run: |
          cd ${{ github.workspace }}/pipeline
          source venv/bin/activate
          echo "Starting AI Test Generation Pipeline..."
          echo "   Target: ${{ steps.detect-repo.outputs.repo_name }}"
          echo "   Branch: ${{ steps.detect-repo.outputs.repo_branch }}"
          echo "   Min Coverage: ${{ inputs.min_coverage || '90' }}%"
          echo ""
          PIPELINE_EXIT_CODE=0
          bash ./pipeline_runner.sh || PIPELINE_EXIT_CODE=$?
          echo "pipeline_exit_code=$PIPELINE_EXIT_CODE" >> $GITHUB_OUTPUT
          if [ $PIPELINE_EXIT_CODE -eq 0 ]; then
            echo "Pipeline completed successfully"
          else
            echo "Pipeline completed with exit code: $PIPELINE_EXIT_CODE"
          fi

      - name: Extract Pipeline Metrics
        id: metrics
        if: always()
        run: |
          cd ${{ github.workspace }}/pipeline
          echo "Extracting pipeline metrics..."

          COVERAGE_BEFORE="${{ steps.coverage-before.outputs.coverage_before }}"
          [ -z "$COVERAGE_BEFORE" ] && COVERAGE_BEFORE="0"

          COVERAGE_AFTER="0"
          if [ -f coverage.xml ]; then
            COVERAGE_AFTER=$(python3 -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); rate = float(root.attrib.get('line-rate', 0)); print(f'{rate * 100:.2f}')" 2>/dev/null || echo "0")
          fi

          COVERAGE_DELTA=$(python3 -c "before = float('$COVERAGE_BEFORE'); after = float('$COVERAGE_AFTER'); delta = after - before; print(f'{delta:+.2f}')" 2>/dev/null || echo "0")

          TESTS_GENERATED=0
          if [ -d tests/generated ]; then
            TESTS_GENERATED=$(find tests/generated -name "test_*.py" -type f | wc -l)
          fi

          TESTS_PASSED="0"
          TESTS_FAILED="0"
          TESTS_TOTAL="0"

          for json_file in .pytest_combined.json .pytest_generated.json .pytest_manual.json; do
            if [ -f "$json_file" ]; then
              TESTS_PASSED=$(python3 -c "import json; data = json.load(open('$json_file')); print(data.get('summary', {}).get('passed', 0))" 2>/dev/null || echo "0")
              TESTS_FAILED=$(python3 -c "import json; data = json.load(open('$json_file')); print(data.get('summary', {}).get('failed', 0))" 2>/dev/null || echo "0")
              TESTS_TOTAL=$(python3 -c "import json; data = json.load(open('$json_file')); print(data.get('summary', {}).get('total', 0))" 2>/dev/null || echo "0")
              break
            fi
          done

          MIN_COVERAGE="${{ inputs.min_coverage || '90' }}"
          DELTA_THRESHOLD="${{ inputs.delta_threshold || '0' }}"

          THRESHOLD_PASSED=$(python3 -c "print('true' if float('$COVERAGE_AFTER') >= float('$MIN_COVERAGE') else 'false')" 2>/dev/null || echo "false")
          DELTA_PASSED=$(python3 -c "delta = float('$COVERAGE_AFTER') - float('$COVERAGE_BEFORE'); print('true' if delta >= float('$DELTA_THRESHOLD') else 'false')" 2>/dev/null || echo "true")

          if [ "$THRESHOLD_PASSED" = "true" ]; then
            PIPELINE_STATUS="success"
          else
            PIPELINE_STATUS="threshold_not_met"
          fi

          echo "coverage_before=$COVERAGE_BEFORE" >> $GITHUB_OUTPUT
          echo "coverage_after=$COVERAGE_AFTER" >> $GITHUB_OUTPUT
          echo "coverage_delta=$COVERAGE_DELTA" >> $GITHUB_OUTPUT
          echo "tests_generated=$TESTS_GENERATED" >> $GITHUB_OUTPUT
          echo "tests_passed=$TESTS_PASSED" >> $GITHUB_OUTPUT
          echo "tests_failed=$TESTS_FAILED" >> $GITHUB_OUTPUT
          echo "tests_total=$TESTS_TOTAL" >> $GITHUB_OUTPUT
          echo "threshold_passed=$THRESHOLD_PASSED" >> $GITHUB_OUTPUT
          echo "delta_passed=$DELTA_PASSED" >> $GITHUB_OUTPUT
          echo "pipeline_status=$PIPELINE_STATUS" >> $GITHUB_OUTPUT
          echo "manual_tests_found=${{ steps.coverage-before.outputs.manual_tests_found }}" >> $GITHUB_OUTPUT

          echo ""
          echo "========================================"
          echo "         PIPELINE METRICS              "
          echo "========================================"
          echo " Coverage Before (Manual):     ${COVERAGE_BEFORE}%"
          echo " Coverage After (AI + Manual): ${COVERAGE_AFTER}%"
          echo " Coverage Delta:               ${COVERAGE_DELTA} pp"
          echo "----------------------------------------"
          echo " Tests Generated:              ${TESTS_GENERATED} files"
          echo " Tests Passed:                 ${TESTS_PASSED}"
          echo " Tests Failed:                 ${TESTS_FAILED}"
          echo "----------------------------------------"
          THRESHOLD_STATUS="PASSED"
          DELTA_STATUS="PASSED"
          [ "$THRESHOLD_PASSED" != "true" ] && THRESHOLD_STATUS="FAILED"
          [ "$DELTA_PASSED" != "true" ] && DELTA_STATUS="FAILED"
          echo " Threshold (${MIN_COVERAGE}%):           $THRESHOLD_STATUS"
          echo " Delta Threshold (${DELTA_THRESHOLD} pp):      $DELTA_STATUS"
          echo "========================================"

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            ${{ github.workspace }}/pipeline/coverage.xml
            ${{ github.workspace }}/pipeline/coverage_before.xml
            ${{ github.workspace }}/pipeline/test-results.xml
            ${{ github.workspace }}/pipeline/.pytest_*.json
            ${{ github.workspace }}/pipeline/auto_fixer_report.json
            ${{ github.workspace }}/pipeline/coverage_gaps.json
            ${{ github.workspace }}/pipeline/manual_test_result.json
          if-no-files-found: warn
          retention-days: 30

      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.run_number }}
          path: |
            ${{ github.workspace }}/pipeline/htmlcov/
            ${{ github.workspace }}/pipeline/ast_full_analysis.json
            ${{ github.workspace }}/pipeline/ast_gap_analysis.json
          if-no-files-found: warn
          retention-days: 30

      - name: Upload Generated Tests
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-tests-${{ github.run_number }}
          path: |
            ${{ github.workspace }}/pipeline/tests/generated/
          if-no-files-found: warn
          retention-days: 30

      - name: Push Generated Tests to Consumer Repository
        id: push-tests
        if: inputs.auto_push_tests == 'true' && steps.metrics.outputs.threshold_passed == 'true'
        env:
          GIT_PUSH_TOKEN: ${{ secrets.GIT_PUSH_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          cd ${{ github.workspace }}/pipeline

          # Check if there are generated tests
          if [ ! -d "tests/generated" ] || [ -z "$(ls -A tests/generated 2>/dev/null)" ]; then
            echo "No generated tests to push"
            echo "tests_pushed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          GENERATED_COUNT=$(find tests/generated -name "test_*.py" -type f | wc -l)
          echo "Found $GENERATED_COUNT generated test files to push"

          # Get repository info
          REPO_URL="${{ steps.detect-repo.outputs.repo_url }}"
          SOURCE_BRANCH="${{ steps.detect-repo.outputs.repo_branch }}"
          TESTS_BRANCH="${{ inputs.tests_branch || 'ai-generated-tests' }}"

          # Convert HTTPS URL to authenticated URL
          # Handle both https://github.com/user/repo.git and https://github.com/user/repo formats
          AUTH_URL=$(echo "$REPO_URL" | sed "s|https://|https://x-access-token:${GIT_PUSH_TOKEN}@|")

          echo "Repository: $REPO_URL"
          echo "Source branch: $SOURCE_BRANCH"
          echo "Tests branch: $TESTS_BRANCH"

          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone consumer repo for pushing tests
          cd ${{ github.workspace }}
          rm -rf consumer-push-repo

          # Check if tests branch already exists
          if git ls-remote --heads "$REPO_URL" "$TESTS_BRANCH" | grep -q "$TESTS_BRANCH"; then
            echo "Tests branch '$TESTS_BRANCH' exists, will update it"
            git clone --branch "$TESTS_BRANCH" "$AUTH_URL" consumer-push-repo
            cd consumer-push-repo

            # Reset to source branch to ensure diff shows only generated tests
            git fetch origin "$SOURCE_BRANCH"
            git reset --hard "origin/$SOURCE_BRANCH"
          else
            echo "Tests branch '$TESTS_BRANCH' does not exist, will create it from '$SOURCE_BRANCH'"
            git clone --branch "$SOURCE_BRANCH" "$AUTH_URL" consumer-push-repo
            cd consumer-push-repo
            git checkout -b "$TESTS_BRANCH"
          fi

          # Create tests/generated directory and copy generated tests
          mkdir -p tests/generated
          cp -r ${{ github.workspace }}/pipeline/tests/generated/* tests/generated/

          # Check if there are changes
          git add tests/generated/

          if git diff --staged --quiet; then
            echo "No new changes to push"
            echo "tests_pushed=false" >> $GITHUB_OUTPUT
          else
            # Commit with simple message (coverage details in commit body via -m flags)
            git commit \
              -m "AI Generated Tests - Run #${{ github.run_number }}" \
              -m "Coverage: ${{ steps.metrics.outputs.coverage_after }}% | Tests: ${GENERATED_COUNT} files | Delta: ${{ steps.metrics.outputs.coverage_delta }} pp" \
              -m "Generated by AI Test Generation Pipeline" \
              -m "Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            git push origin "$TESTS_BRANCH" --force

            echo "tests_pushed=true" >> $GITHUB_OUTPUT
            echo "Generated tests pushed to branch: $TESTS_BRANCH"
          fi

          # Generate branch URL for output
          # Convert git URL to browser URL
          BROWSER_URL=$(echo "$REPO_URL" | sed 's/\.git$//')
          BRANCH_URL="${BROWSER_URL}/tree/${TESTS_BRANCH}"
          COMPARE_URL="${BROWSER_URL}/compare/${SOURCE_BRANCH}...${TESTS_BRANCH}"

          echo "tests_branch_url=$BRANCH_URL" >> $GITHUB_OUTPUT
          echo "compare_url=$COMPARE_URL" >> $GITHUB_OUTPUT
          echo ""
          echo "========================================"
          echo "  Generated Tests Branch"
          echo "========================================"
          echo "  Branch: $TESTS_BRANCH"
          echo "  View:   $BRANCH_URL"
          echo "  Diff:   $COMPARE_URL"
          echo "========================================"

      - name: Deploy Coverage to GitHub Pages
        id: deploy-pages
        if: always()
        run: |
          cd ${{ github.workspace }}

          if [ ! -d "pipeline/htmlcov" ] || [ -z "$(ls -A pipeline/htmlcov 2>/dev/null)" ]; then
            echo "No coverage report to deploy"
            exit 0
          fi

          echo "Deploying coverage report to GitHub Pages..."

          # Collect metrics for the dashboard
          COV_BEFORE="${{ steps.metrics.outputs.coverage_before }}"
          COV_AFTER="${{ steps.metrics.outputs.coverage_after }}"
          COV_DELTA="${{ steps.metrics.outputs.coverage_delta }}"
          TESTS_GEN="${{ steps.metrics.outputs.tests_generated }}"
          TESTS_PASS="${{ steps.metrics.outputs.tests_passed }}"
          TESTS_FAIL="${{ steps.metrics.outputs.tests_failed }}"
          TESTS_TOTAL="${{ steps.metrics.outputs.tests_total }}"
          THRESHOLD_OK="${{ steps.metrics.outputs.threshold_passed }}"
          REPO_NAME="${{ steps.detect-repo.outputs.repo_name }}"
          BRANCH="${{ steps.detect-repo.outputs.repo_branch }}"
          RUN_NUM="${{ github.run_number }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")

          COV_INT=$(python3 -c "print(int(float('$COV_AFTER')))" 2>/dev/null || echo "0")
          PASS_RATE="0"
          if [ "$TESTS_TOTAL" != "0" ]; then
            PASS_RATE=$(python3 -c "print(f'{(int(\"$TESTS_PASS\") / int(\"$TESTS_TOTAL\")) * 100:.0f}')" 2>/dev/null || echo "0")
          fi

          # Determine coverage color
          if [ "$COV_INT" -ge 90 ]; then COV_HUE="142"; COV_LABEL="Excellent"
          elif [ "$COV_INT" -ge 70 ]; then COV_HUE="60"; COV_LABEL="Good"
          elif [ "$COV_INT" -ge 50 ]; then COV_HUE="30"; COV_LABEL="Fair"
          else COV_HUE="0"; COV_LABEL="Low"; fi

          # Status banner
          if [ "$THRESHOLD_OK" = "true" ]; then
            STATUS_CLASS="status-passed"
            STATUS_TEXT="Quality Gate Passed"
          else
            STATUS_CLASS="status-failed"
            STATUS_TEXT="Quality Gate Not Met"
          fi

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git clone --depth=1 --branch gh-pages "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" gh-pages-deploy 2>/dev/null || {
            echo "Creating new gh-pages branch..."
            mkdir gh-pages-deploy
            cd gh-pages-deploy
            git init
            git checkout -b gh-pages
            touch .nojekyll
            git add .
            git commit -m "Initialize gh-pages"
            cd ..
          }

          REPORT_DIR="coverage/run-${RUN_NUM}"
          mkdir -p "gh-pages-deploy/$REPORT_DIR/detail"

          # Copy raw htmlcov into detail/ subdirectory
          cp -r pipeline/htmlcov/* "gh-pages-deploy/$REPORT_DIR/detail/"

          # Generate detailed per-file and per-test data for the dashboard
          python3 << 'PYEOF' > "gh-pages-deploy/$REPORT_DIR/data.js"
          import xml.etree.ElementTree as ET
          import json, os, sys

          ws = os.environ.get('GITHUB_WORKSPACE', '.')
          pipeline = os.path.join(ws, 'pipeline')
          data = {'files': [], 'tests': []}

          # Parse coverage.xml for per-file coverage
          cov_xml = os.path.join(pipeline, 'coverage.xml')
          if os.path.exists(cov_xml):
              try:
                  tree = ET.parse(cov_xml)
                  for cls in tree.findall('.//class'):
                      fn = cls.attrib.get('filename', '')
                      lr = float(cls.attrib.get('line-rate', 0))
                      lines = cls.findall('.//line')
                      total = len(lines)
                      hit = sum(1 for l in lines if int(l.attrib.get('hits', 0)) > 0)
                      data['files'].append({
                          'f': fn, 's': total, 'h': hit,
                          'm': total - hit, 'c': round(lr * 100, 1)
                      })
              except Exception as e:
                  print(f"// coverage.xml parse error: {e}", file=sys.stderr)

          # Parse pytest JSON for per-test results
          for jf in ['.pytest_combined.json', '.pytest_generated.json', '.pytest_manual.json']:
              fpath = os.path.join(pipeline, jf)
              if os.path.exists(fpath):
                  try:
                      with open(fpath) as f:
                          jdata = json.load(f)
                      for t in jdata.get('tests', []):
                          data['tests'].append({
                              'n': t.get('nodeid', ''),
                              'o': t.get('outcome', 'unknown'),
                              'd': round(t.get('duration', 0), 3)
                          })
                  except Exception as e:
                      print(f"// pytest json parse error: {e}", file=sys.stderr)
                  break

          sys.stdout.write('window.PIPELINE_DATA=' + json.dumps(data, separators=(',',':')) + ';\n')
          PYEOF

          echo "Generated data.js for dashboard"

          # Generate professional dashboard index.html
          cat > "gh-pages-deploy/$REPORT_DIR/index.html" << 'DASHBOARD_EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Coverage Report â€” REPO_PLACEHOLDER</title>
            <style>
              :root {
                --primary: #1a73e8;
                --success: #1e8e3e;
                --danger: #d93025;
                --warn: #f9ab00;
                --bg: #f8f9fa;
                --card: #ffffff;
                --text: #202124;
                --muted: #5f6368;
                --border: #dadce0;
                --cov-hue: COV_HUE_PLACEHOLDER;
              }
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                background: var(--bg);
                color: var(--text);
                line-height: 1.6;
              }
              .header {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
                color: white;
                padding: 2rem 0;
                text-align: center;
              }
              .header h1 { font-size: 1.8rem; font-weight: 600; margin-bottom: 0.25rem; }
              .header p { opacity: 0.8; font-size: 0.95rem; }
              .status-banner {
                padding: 0.75rem;
                text-align: center;
                font-weight: 600;
                font-size: 0.95rem;
                letter-spacing: 0.5px;
              }
              .status-passed { background: var(--success); color: white; }
              .status-failed { background: var(--danger); color: white; }
              .container {
                max-width: 1100px;
                margin: 0 auto;
                padding: 2rem 1.5rem;
              }
              .grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 1.25rem;
                margin-bottom: 2rem;
              }
              .card {
                background: var(--card);
                border-radius: 12px;
                padding: 1.5rem;
                border: 1px solid var(--border);
                box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                transition: box-shadow 0.2s;
              }
              .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
              .card-label {
                font-size: 0.8rem;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: var(--muted);
                margin-bottom: 0.5rem;
              }
              .card-value {
                font-size: 2.2rem;
                font-weight: 700;
                line-height: 1.2;
              }
              .card-sub { font-size: 0.85rem; color: var(--muted); margin-top: 0.25rem; }

              /* Coverage ring */
              .cov-ring-card { display: flex; align-items: center; gap: 1.5rem; }
              .cov-ring {
                position: relative;
                width: 110px;
                height: 110px;
                flex-shrink: 0;
              }
              .cov-ring svg { transform: rotate(-90deg); }
              .cov-ring-bg { fill: none; stroke: #e8eaed; stroke-width: 8; }
              .cov-ring-fill {
                fill: none;
                stroke: hsl(var(--cov-hue), 70%, 45%);
                stroke-width: 8;
                stroke-linecap: round;
                stroke-dasharray: 314;
                stroke-dashoffset: RING_OFFSET_PLACEHOLDER;
                transition: stroke-dashoffset 1s ease;
              }
              .cov-ring-text {
                position: absolute;
                top: 50%; left: 50%;
                transform: translate(-50%, -50%);
                font-size: 1.5rem;
                font-weight: 700;
                color: hsl(var(--cov-hue), 70%, 40%);
              }
              .cov-info { flex: 1; }
              .cov-info .label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); }
              .cov-info .rating {
                font-size: 1rem;
                font-weight: 600;
                color: hsl(var(--cov-hue), 70%, 40%);
                margin-top: 0.25rem;
              }

              /* Delta badge */
              .delta-positive { color: var(--success); }
              .delta-negative { color: var(--danger); }
              .delta-neutral { color: var(--muted); }

              /* Progress bar */
              .progress-bar {
                width: 100%;
                height: 8px;
                background: #e8eaed;
                border-radius: 4px;
                margin-top: 0.75rem;
                overflow: hidden;
              }
              .progress-fill {
                height: 100%;
                border-radius: 4px;
                background: hsl(var(--cov-hue), 70%, 45%);
                transition: width 1s ease;
              }

              /* Section */
              .section-title {
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid var(--border);
              }

              /* CTA button */
              .btn {
                display: inline-block;
                padding: 0.75rem 1.5rem;
                border-radius: 8px;
                text-decoration: none;
                font-weight: 600;
                font-size: 0.95rem;
                transition: all 0.2s;
              }
              .btn-primary { background: var(--primary); color: white; }
              .btn-primary:hover { background: #1557b0; transform: translateY(-1px); }
              .btn-outline {
                background: transparent;
                color: var(--primary);
                border: 2px solid var(--primary);
              }
              .btn-outline:hover { background: var(--primary); color: white; }
              .btn-group { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1.5rem; }

              /* Meta bar */
              .meta-bar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 1rem 0;
                margin-top: 2rem;
                border-top: 1px solid var(--border);
                font-size: 0.8rem;
                color: var(--muted);
              }

              /* Table styling */
              .quality-table { width: 100%; border-collapse: collapse; margin-top: 0.75rem; }
              .quality-table th, .quality-table td {
                padding: 0.6rem 1rem;
                text-align: left;
                border-bottom: 1px solid var(--border);
              }
              .quality-table th { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); }
              .badge {
                display: inline-block;
                padding: 0.15rem 0.6rem;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 600;
              }
              .badge-pass { background: #e6f4ea; color: var(--success); }
              .badge-fail { background: #fce8e6; color: var(--danger); }

              /* Tabs */
              .tab-nav {
                display: flex;
                gap: 0;
                border-bottom: 2px solid var(--border);
                margin-bottom: 2rem;
                overflow-x: auto;
              }
              .tab-btn {
                padding: 0.75rem 1.5rem;
                border: none;
                background: none;
                cursor: pointer;
                font-size: 0.95rem;
                font-weight: 500;
                color: var(--muted);
                border-bottom: 2px solid transparent;
                margin-bottom: -2px;
                transition: all 0.2s;
                white-space: nowrap;
              }
              .tab-btn:hover { color: var(--text); }
              .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }
              .tab-content { display: none; }
              .tab-content.active { display: block; }

              /* File coverage table */
              .file-table { width: 100%; border-collapse: collapse; }
              .file-table th, .file-table td {
                padding: 0.6rem 1rem;
                text-align: left;
                border-bottom: 1px solid var(--border);
              }
              .file-table th {
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--muted);
                cursor: pointer;
                user-select: none;
                position: sticky;
                top: 0;
                background: var(--card);
              }
              .file-table th:hover { color: var(--text); }
              .file-table tr:hover td { background: #f1f3f4; }
              .file-link { color: var(--primary); text-decoration: none; word-break: break-all; font-size: 0.88rem; }
              .file-link:hover { text-decoration: underline; }
              .mini-bar { width: 100%; height: 6px; background: #e8eaed; border-radius: 3px; overflow: hidden; }
              .mini-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
              .file-summary { display: flex; gap: 2rem; padding: 1rem 0; flex-wrap: wrap; }
              .file-summary-item { font-size: 0.85rem; color: var(--muted); }
              .file-summary-item strong { color: var(--text); font-size: 1rem; }
              .file-table-wrap { max-height: 600px; overflow-y: auto; border-radius: 8px; }

              /* Search */
              .search-bar { margin-bottom: 1rem; }
              .search-bar input {
                width: 100%;
                padding: 0.65rem 1rem;
                border: 1px solid var(--border);
                border-radius: 8px;
                font-size: 0.9rem;
                outline: none;
                transition: border-color 0.2s;
                background: var(--card);
              }
              .search-bar input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26,115,232,0.1); }

              /* Test groups */
              .test-group { margin-bottom: 0.75rem; }
              .test-group-header {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.75rem 1rem;
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 8px;
                cursor: pointer;
                user-select: none;
                font-weight: 600;
                font-size: 0.9rem;
                transition: background 0.15s;
              }
              .test-group-header:hover { background: #f1f3f4; }
              .test-group-header.expanded { border-radius: 8px 8px 0 0; }
              .test-group-body {
                border: 1px solid var(--border);
                border-top: none;
                border-radius: 0 0 8px 8px;
                overflow: hidden;
              }
              .test-item {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.5rem 1rem;
                border-bottom: 1px solid #f1f3f4;
                font-size: 0.85rem;
              }
              .test-item:last-child { border-bottom: none; }
              .test-name { flex: 1; word-break: break-all; font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; font-size: 0.82rem; }
              .test-duration { color: var(--muted); font-size: 0.78rem; min-width: 55px; text-align: right; }
              .badge-passed { background: #e6f4ea; color: var(--success); }
              .badge-failed { background: #fce8e6; color: var(--danger); }
              .badge-skipped { background: #fef7e0; color: var(--warn); }
              .badge-error { background: #fce8e6; color: var(--danger); }
              .sort-icon { font-size: 0.65rem; opacity: 0.4; margin-left: 0.25rem; }
              .chevron { transition: transform 0.2s; display: inline-block; font-size: 0.7rem; }
              .chevron.open { transform: rotate(90deg); }
              .test-summary-bar {
                display: flex;
                gap: 1.5rem;
                margin-bottom: 1.25rem;
                flex-wrap: wrap;
                padding: 1rem 1.25rem;
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 8px;
              }
              .test-summary-item { font-size: 0.85rem; color: var(--muted); }
              .test-summary-item strong { color: var(--text); font-size: 1.05rem; }
              .empty-state {
                text-align: center;
                padding: 3rem 2rem;
                color: var(--muted);
                font-size: 0.95rem;
              }
              .empty-state svg { margin-bottom: 1rem; opacity: 0.3; }

              @media (max-width: 600px) {
                .container { padding: 1rem; }
                .grid { grid-template-columns: 1fr 1fr; }
                .cov-ring-card { flex-direction: column; text-align: center; }
                .tab-btn { padding: 0.6rem 1rem; font-size: 0.85rem; }
                .file-table th, .file-table td { padding: 0.4rem 0.5rem; font-size: 0.8rem; }
              }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>Coverage Report</h1>
              <p>REPO_PLACEHOLDER &mdash; BRANCH_PLACEHOLDER &mdash; Run #RUN_NUM_PLACEHOLDER</p>
            </div>

            <div class="STATUS_CLASS_PLACEHOLDER">STATUS_TEXT_PLACEHOLDER</div>

            <div class="container">
              <!-- Tab Navigation -->
              <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('overview',this)">Overview</button>
                <button class="tab-btn" onclick="switchTab('files',this)">File Coverage</button>
                <button class="tab-btn" onclick="switchTab('tests',this)">Test Details</button>
              </div>

              <!-- TAB: Overview -->
              <div id="tab-overview" class="tab-content active">
                <div class="grid">
                  <div class="card cov-ring-card" style="grid-column: span 2;">
                    <div class="cov-ring">
                      <svg width="110" height="110" viewBox="0 0 110 110">
                        <circle class="cov-ring-bg" cx="55" cy="55" r="50"/>
                        <circle class="cov-ring-fill" cx="55" cy="55" r="50"/>
                      </svg>
                      <div class="cov-ring-text">COV_AFTER_PLACEHOLDER%</div>
                    </div>
                    <div class="cov-info">
                      <div class="label">Final Coverage</div>
                      <div class="rating">COV_LABEL_PLACEHOLDER</div>
                      <div class="progress-bar">
                        <div class="progress-fill" style="width: COV_AFTER_PLACEHOLDER%"></div>
                      </div>
                      <div style="display:flex; justify-content:space-between; margin-top:0.25rem;">
                        <span style="font-size:0.75rem; color:var(--muted);">0%</span>
                        <span style="font-size:0.75rem; color:var(--muted);">100%</span>
                      </div>
                    </div>
                  </div>

                  <div class="card">
                    <div class="card-label">Before</div>
                    <div class="card-value">COV_BEFORE_PLACEHOLDER%</div>
                    <div class="card-sub">Manual tests coverage</div>
                  </div>

                  <div class="card">
                    <div class="card-label">Improvement</div>
                    <div class="card-value DELTA_CLASS_PLACEHOLDER">COV_DELTA_PLACEHOLDER pp</div>
                    <div class="card-sub">Coverage delta</div>
                  </div>
                </div>

                <!-- Test Results Summary -->
                <h3 class="section-title">Test Results</h3>
                <div class="grid" style="grid-template-columns: repeat(4, 1fr);">
                  <div class="card" style="text-align:center;">
                    <div class="card-label">Generated</div>
                    <div class="card-value" style="color: var(--primary);">TESTS_GEN_PLACEHOLDER</div>
                    <div class="card-sub">test files</div>
                  </div>
                  <div class="card" style="text-align:center;">
                    <div class="card-label">Total</div>
                    <div class="card-value">TESTS_TOTAL_PLACEHOLDER</div>
                    <div class="card-sub">test cases</div>
                  </div>
                  <div class="card" style="text-align:center;">
                    <div class="card-label">Passed</div>
                    <div class="card-value" style="color: var(--success);">TESTS_PASS_PLACEHOLDER</div>
                    <div class="card-sub">PASS_RATE_PLACEHOLDER% pass rate</div>
                  </div>
                  <div class="card" style="text-align:center;">
                    <div class="card-label">Failed</div>
                    <div class="card-value" style="color: FAIL_COLOR_PLACEHOLDER;">TESTS_FAIL_PLACEHOLDER</div>
                    <div class="card-sub">test cases</div>
                  </div>
                </div>

                <!-- Quality Gates -->
                <h3 class="section-title">Quality Gates</h3>
                <div class="card">
                  <table class="quality-table">
                    <thead>
                      <tr><th>Gate</th><th>Required</th><th>Actual</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>Coverage Threshold</td>
                        <td>&ge; MIN_COV_PLACEHOLDER%</td>
                        <td>COV_AFTER_PLACEHOLDER%</td>
                        <td><span class="badge THRESHOLD_BADGE_PLACEHOLDER">THRESHOLD_TEXT_PLACEHOLDER</span></td>
                      </tr>
                      <tr>
                        <td>Delta Threshold</td>
                        <td>&ge; DELTA_REQ_PLACEHOLDER pp</td>
                        <td>COV_DELTA_PLACEHOLDER pp</td>
                        <td><span class="badge DELTA_BADGE_PLACEHOLDER">DELTA_TEXT_PLACEHOLDER</span></td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="btn-group">
                  <a class="btn btn-primary" href="detail/index.html">View Raw Coverage Report</a>
                  <a class="btn btn-outline" href="RUN_URL_PLACEHOLDER">View Pipeline Run</a>
                </div>
              </div>

              <!-- TAB: File Coverage -->
              <div id="tab-files" class="tab-content">
                <div id="file-summary" class="file-summary"></div>
                <div class="search-bar">
                  <input type="text" id="file-search" placeholder="Search files by name..." oninput="filterFiles()">
                </div>
                <div class="card" style="padding:0; overflow:hidden;">
                  <div class="file-table-wrap">
                    <table class="file-table">
                      <thead>
                        <tr>
                          <th onclick="sortFiles('f')">File <span class="sort-icon">&#8597;</span></th>
                          <th onclick="sortFiles('s')" style="width:70px">Stmts <span class="sort-icon">&#8597;</span></th>
                          <th onclick="sortFiles('m')" style="width:60px">Miss <span class="sort-icon">&#8597;</span></th>
                          <th onclick="sortFiles('h')" style="width:70px">Cover <span class="sort-icon">&#8597;</span></th>
                          <th onclick="sortFiles('c')" style="width:80px">% <span class="sort-icon">&#8597;</span></th>
                          <th style="width:130px">Progress</th>
                        </tr>
                      </thead>
                      <tbody id="file-tbody"></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- TAB: Test Details -->
              <div id="tab-tests" class="tab-content">
                <div id="test-summary" class="test-summary-bar"></div>
                <div class="search-bar">
                  <input type="text" id="test-search" placeholder="Search tests by name, file, or class..." oninput="filterTests()">
                </div>
                <div id="test-groups"></div>
              </div>

              <!-- Footer -->
              <div class="meta-bar">
                <span>Generated by AI Test Generation Pipeline</span>
                <span>TIMESTAMP_PLACEHOLDER</span>
              </div>
            </div>

            <script src="data.js"></script>
            <script>
            (function(){
              var D=window.PIPELINE_DATA||{files:[],tests:[]};
              var sCol='c',sAsc=false;

              function hue(c){return c>=90?142:c>=70?60:c>=50?30:0;}

              /* ---- File Coverage Tab ---- */
              function renderFileSummary(){
                var el=document.getElementById('file-summary');
                if(!el||!D.files.length)return;
                var ts=0,th=0,tm=0;
                D.files.forEach(function(f){ts+=f.s;th+=f.h;tm+=f.m;});
                var avg=ts?Math.round(th/ts*100):0;
                el.innerHTML=
                  '<div class="file-summary-item"><strong>'+D.files.length+'</strong> files analyzed</div>'+
                  '<div class="file-summary-item"><strong>'+ts+'</strong> total statements</div>'+
                  '<div class="file-summary-item"><strong>'+th+'</strong> covered</div>'+
                  '<div class="file-summary-item"><strong>'+tm+'</strong> missed</div>'+
                  '<div class="file-summary-item">Avg: <strong>'+avg+'%</strong></div>';
              }

              function renderFiles(q){
                var tbody=document.getElementById('file-tbody');
                if(!tbody)return;
                if(!D.files.length){
                  tbody.innerHTML='<tr><td colspan="6" class="empty-state">No file coverage data available</td></tr>';
                  return;
                }
                var files=D.files.slice();
                if(q){var ql=q.toLowerCase();files=files.filter(function(f){return f.f.toLowerCase().indexOf(ql)>=0;});}
                files.sort(function(a,b){
                  var va=a[sCol],vb=b[sCol];
                  if(typeof va==='string')return sAsc?va.localeCompare(vb):vb.localeCompare(va);
                  return sAsc?va-vb:vb-va;
                });
                var html='';
                files.forEach(function(f){
                  var h=hue(f.c);
                  var link='detail/'+f.f.replace(/\//g,'_').replace(/\./g,'_')+'.html';
                  html+='<tr>'+
                    '<td><a class="file-link" href="'+link+'" title="'+f.f+'">'+f.f+'</a></td>'+
                    '<td>'+f.s+'</td>'+
                    '<td style="color:'+(f.m>0?'var(--danger)':'var(--muted)')+'">'+f.m+'</td>'+
                    '<td>'+f.h+'</td>'+
                    '<td style="font-weight:700;color:hsl('+h+',70%,40%)">'+f.c+'%</td>'+
                    '<td><div class="mini-bar"><div class="mini-fill" style="width:'+f.c+'%;background:hsl('+h+',70%,45%)"></div></div></td>'+
                    '</tr>';
                });
                if(!html)html='<tr><td colspan="6" class="empty-state">No files match your search</td></tr>';
                tbody.innerHTML=html;
              }

              window.sortFiles=function(col){
                if(sCol===col)sAsc=!sAsc;else{sCol=col;sAsc=col==='f';}
                renderFiles(document.getElementById('file-search').value);
              };
              window.filterFiles=function(){renderFiles(document.getElementById('file-search').value);};

              /* ---- Test Details Tab ---- */
              function renderTestSummary(){
                var el=document.getElementById('test-summary');
                if(!el||!D.tests.length){if(el)el.style.display='none';return;}
                var p=0,f=0,s=0,e=0;
                D.tests.forEach(function(t){
                  if(t.o==='passed')p++;else if(t.o==='failed')f++;else if(t.o==='skipped')s++;else e++;
                });
                el.innerHTML=
                  '<div class="test-summary-item"><strong>'+D.tests.length+'</strong> total tests</div>'+
                  '<div class="test-summary-item" style="color:var(--success)"><strong>'+p+'</strong> passed</div>'+
                  (f?'<div class="test-summary-item" style="color:var(--danger)"><strong>'+f+'</strong> failed</div>':'')+
                  (s?'<div class="test-summary-item" style="color:var(--warn)"><strong>'+s+'</strong> skipped</div>':'')+
                  (e?'<div class="test-summary-item" style="color:var(--danger)"><strong>'+e+'</strong> errors</div>':'');
              }

              function renderTests(q){
                var container=document.getElementById('test-groups');
                if(!container)return;
                if(!D.tests.length){
                  container.innerHTML='<div class="empty-state">No test results available</div>';
                  return;
                }
                var groups={};
                D.tests.forEach(function(t){
                  var parts=t.n.split('::');
                  var file=parts[0]||'unknown';
                  if(!groups[file])groups[file]=[];
                  groups[file].push({name:parts.slice(1).join(' :: '),outcome:t.o,duration:t.d,raw:t.n});
                });
                var keys=Object.keys(groups).sort();
                if(q){
                  var ql=q.toLowerCase();
                  keys=keys.filter(function(k){
                    if(k.toLowerCase().indexOf(ql)>=0)return true;
                    return groups[k].some(function(t){return t.raw.toLowerCase().indexOf(ql)>=0;});
                  });
                }
                var html='';
                keys.forEach(function(file,idx){
                  var tests=groups[file];
                  if(q){
                    var ql=q.toLowerCase();
                    if(file.toLowerCase().indexOf(ql)<0){
                      tests=tests.filter(function(t){return t.raw.toLowerCase().indexOf(ql)>=0;});
                    }
                  }
                  var passed=tests.filter(function(t){return t.o==='passed';}).length;
                  var failed=tests.filter(function(t){return t.o==='failed';}).length;
                  var bc=failed>0?'badge-failed':'badge-passed';
                  var st=failed>0?failed+' failed':'all passed';

                  html+='<div class="test-group">'+
                    '<div class="test-group-header expanded" onclick="toggleGroup('+idx+')">'+
                    '<span class="chevron open" id="chev-'+idx+'">&#9654;</span>'+
                    '<span style="flex:1;word-break:break-all">'+file+'</span>'+
                    '<span class="badge '+bc+'">'+st+'</span>'+
                    '<span style="color:var(--muted);font-size:0.78rem">'+tests.length+' tests</span>'+
                    '</div>'+
                    '<div class="test-group-body" id="grp-'+idx+'">';

                  tests.forEach(function(t){
                    var tbc=t.outcome==='passed'?'badge-passed':t.outcome==='failed'?'badge-failed':t.outcome==='skipped'?'badge-skipped':'badge-error';
                    html+='<div class="test-item">'+
                      '<span class="badge '+tbc+'">'+t.outcome+'</span>'+
                      '<span class="test-name">'+t.name+'</span>'+
                      '<span class="test-duration">'+t.duration+'s</span>'+
                      '</div>';
                  });

                  html+='</div></div>';
                });
                if(!html)html='<div class="empty-state">No tests match your search</div>';
                container.innerHTML=html;
              }

              window.toggleGroup=function(idx){
                var body=document.getElementById('grp-'+idx);
                var chev=document.getElementById('chev-'+idx);
                var hdr=chev.parentElement;
                if(body.style.display==='none'){
                  body.style.display='block';chev.classList.add('open');hdr.classList.add('expanded');
                }else{
                  body.style.display='none';chev.classList.remove('open');hdr.classList.remove('expanded');
                }
              };
              window.filterTests=function(){renderTests(document.getElementById('test-search').value);};

              /* ---- Tab Switching ---- */
              window.switchTab=function(tab,btn){
                document.querySelectorAll('.tab-btn').forEach(function(b){b.classList.remove('active');});
                document.querySelectorAll('.tab-content').forEach(function(c){c.classList.remove('active');c.style.display='none';});
                var el=document.getElementById('tab-'+tab);
                if(el){el.classList.add('active');el.style.display='block';}
                if(btn)btn.classList.add('active');
              };

              /* ---- Init ---- */
              renderFileSummary();
              renderFiles();
              renderTestSummary();
              renderTests();
            })();
            </script>
          </body>
          </html>
          DASHBOARD_EOF

          # Replace all placeholders in the dashboard
          cd gh-pages-deploy
          sed -i "s|REPO_PLACEHOLDER|${REPO_NAME}|g" "$REPORT_DIR/index.html"
          sed -i "s|BRANCH_PLACEHOLDER|${BRANCH}|g" "$REPORT_DIR/index.html"
          sed -i "s|RUN_NUM_PLACEHOLDER|${RUN_NUM}|g" "$REPORT_DIR/index.html"
          sed -i "s|COV_BEFORE_PLACEHOLDER|${COV_BEFORE}|g" "$REPORT_DIR/index.html"
          sed -i "s|COV_AFTER_PLACEHOLDER|${COV_AFTER}|g" "$REPORT_DIR/index.html"
          sed -i "s|COV_DELTA_PLACEHOLDER|${COV_DELTA}|g" "$REPORT_DIR/index.html"
          sed -i "s|COV_HUE_PLACEHOLDER|${COV_HUE}|g" "$REPORT_DIR/index.html"
          sed -i "s|COV_LABEL_PLACEHOLDER|${COV_LABEL}|g" "$REPORT_DIR/index.html"
          sed -i "s|TESTS_GEN_PLACEHOLDER|${TESTS_GEN}|g" "$REPORT_DIR/index.html"
          sed -i "s|TESTS_TOTAL_PLACEHOLDER|${TESTS_TOTAL}|g" "$REPORT_DIR/index.html"
          sed -i "s|TESTS_PASS_PLACEHOLDER|${TESTS_PASS}|g" "$REPORT_DIR/index.html"
          sed -i "s|TESTS_FAIL_PLACEHOLDER|${TESTS_FAIL}|g" "$REPORT_DIR/index.html"
          sed -i "s|PASS_RATE_PLACEHOLDER|${PASS_RATE}|g" "$REPORT_DIR/index.html"
          sed -i "s|MIN_COV_PLACEHOLDER|${{ inputs.min_coverage || '90' }}|g" "$REPORT_DIR/index.html"
          sed -i "s|DELTA_REQ_PLACEHOLDER|${{ inputs.delta_threshold || '0' }}|g" "$REPORT_DIR/index.html"
          sed -i "s|STATUS_CLASS_PLACEHOLDER|status-banner ${STATUS_CLASS}|g" "$REPORT_DIR/index.html"
          sed -i "s|STATUS_TEXT_PLACEHOLDER|${STATUS_TEXT}|g" "$REPORT_DIR/index.html"
          sed -i "s|TIMESTAMP_PLACEHOLDER|${TIMESTAMP}|g" "$REPORT_DIR/index.html"
          sed -i "s|RUN_URL_PLACEHOLDER|${RUN_URL}|g" "$REPORT_DIR/index.html"

          # Calculate SVG ring offset: 314 - (314 * coverage / 100)
          RING_OFFSET=$(python3 -c "print(f'{314 - (314 * float(\"$COV_AFTER\") / 100):.0f}')" 2>/dev/null || echo "314")
          sed -i "s|RING_OFFSET_PLACEHOLDER|${RING_OFFSET}|g" "$REPORT_DIR/index.html"

          # Delta class
          DELTA_NUM=$(python3 -c "d=float('${COV_DELTA}'.replace('+','')); print('positive' if d>0 else ('negative' if d<0 else 'neutral'))" 2>/dev/null || echo "neutral")
          sed -i "s|DELTA_CLASS_PLACEHOLDER|delta-${DELTA_NUM}|g" "$REPORT_DIR/index.html"

          # Fail color
          if [ "$TESTS_FAIL" = "0" ]; then
            sed -i "s|FAIL_COLOR_PLACEHOLDER|var(--muted)|g" "$REPORT_DIR/index.html"
          else
            sed -i "s|FAIL_COLOR_PLACEHOLDER|var(--danger)|g" "$REPORT_DIR/index.html"
          fi

          # Threshold badges
          if [ "$THRESHOLD_OK" = "true" ]; then
            sed -i "s|THRESHOLD_BADGE_PLACEHOLDER|badge-pass|g" "$REPORT_DIR/index.html"
            sed -i "s|THRESHOLD_TEXT_PLACEHOLDER|PASSED|g" "$REPORT_DIR/index.html"
          else
            sed -i "s|THRESHOLD_BADGE_PLACEHOLDER|badge-fail|g" "$REPORT_DIR/index.html"
            sed -i "s|THRESHOLD_TEXT_PLACEHOLDER|FAILED|g" "$REPORT_DIR/index.html"
          fi

          DELTA_OK_VAL="${{ steps.metrics.outputs.delta_passed }}"
          if [ "$DELTA_OK_VAL" = "true" ]; then
            sed -i "s|DELTA_BADGE_PLACEHOLDER|badge-pass|g" "$REPORT_DIR/index.html"
            sed -i "s|DELTA_TEXT_PLACEHOLDER|PASSED|g" "$REPORT_DIR/index.html"
          else
            sed -i "s|DELTA_BADGE_PLACEHOLDER|badge-fail|g" "$REPORT_DIR/index.html"
            sed -i "s|DELTA_TEXT_PLACEHOLDER|FAILED|g" "$REPORT_DIR/index.html"
          fi

          # Also create a root index that redirects to latest run
          cat > "index.html" << ROOT_EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta http-equiv="refresh" content="0; url=coverage/run-${RUN_NUM}/index.html">
            <title>Redirecting to latest coverage report...</title>
          </head>
          <body>
            <p>Redirecting to <a href="coverage/run-${RUN_NUM}/index.html">latest coverage report</a>...</p>
          </body>
          </html>
          ROOT_EOF

          touch .nojekyll
          git add -A

          if git diff --staged --quiet; then
            echo "No changes to deploy"
          else
            git commit -m "Deploy coverage report for run #${RUN_NUM}"
            git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" 2>/dev/null || git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
            git push origin gh-pages --force
            echo "Coverage report deployed!"
          fi

          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME_GH="${{ github.event.repository.name }}"
          PAGES_URL="https://${REPO_OWNER}.github.io/${REPO_NAME_GH}/coverage/run-${RUN_NUM}/index.html"

          echo "pages_url=$PAGES_URL" >> $GITHUB_OUTPUT
          echo "Coverage report: $PAGES_URL"

      - name: Generate Job Summary
        if: always()
        run: |
          # Collect all values
          REPO_NAME="${{ steps.detect-repo.outputs.repo_name }}"
          BRANCH="${{ steps.detect-repo.outputs.repo_branch }}"
          COV_BEFORE="${{ steps.metrics.outputs.coverage_before }}"
          COV_AFTER="${{ steps.metrics.outputs.coverage_after }}"
          COV_DELTA="${{ steps.metrics.outputs.coverage_delta }}"
          TESTS_GEN="${{ steps.metrics.outputs.tests_generated }}"
          TESTS_PASS="${{ steps.metrics.outputs.tests_passed }}"
          TESTS_FAIL="${{ steps.metrics.outputs.tests_failed }}"
          TESTS_TOTAL="${{ steps.metrics.outputs.tests_total }}"
          THRESHOLD_OK="${{ steps.metrics.outputs.threshold_passed }}"
          DELTA_OK="${{ steps.metrics.outputs.delta_passed }}"
          MANUAL_FOUND="${{ steps.metrics.outputs.manual_tests_found }}"
          MIN_COV="${{ inputs.min_coverage || '90' }}"
          DELTA_REQ="${{ inputs.delta_threshold || '0' }}"
          PAGES_URL="${{ steps.deploy-pages.outputs.pages_url }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Determine overall status
          if [ "$THRESHOLD_OK" = "true" ] && [ "$DELTA_OK" = "true" ]; then
            STATUS_ICON="<picture><img alt='passed' src='https://img.shields.io/badge/Pipeline-PASSED-brightgreen?style=for-the-badge&logo=githubactions&logoColor=white' /></picture>"
            STATUS_TEXT="All quality gates passed"
          else
            STATUS_ICON="<picture><img alt='failed' src='https://img.shields.io/badge/Pipeline-THRESHOLD%20NOT%20MET-red?style=for-the-badge&logo=githubactions&logoColor=white' /></picture>"
            STATUS_TEXT="Coverage threshold not met"
          fi

          # Coverage progress bar (using Unicode block characters)
          COV_INT=$(python3 -c "print(int(float('$COV_AFTER')))" 2>/dev/null || echo "0")
          FILLED=$((COV_INT / 5))
          EMPTY=$((20 - FILLED))
          BAR=""
          for i in $(seq 1 $FILLED); do BAR="${BAR}â–ˆ"; done
          for i in $(seq 1 $EMPTY); do BAR="${BAR}â–‘"; done

          # Coverage color badge
          if [ "$COV_INT" -ge 90 ]; then
            COV_COLOR="brightgreen"
          elif [ "$COV_INT" -ge 70 ]; then
            COV_COLOR="yellow"
          elif [ "$COV_INT" -ge 50 ]; then
            COV_COLOR="orange"
          else
            COV_COLOR="red"
          fi

          # Pass rate
          PASS_RATE="0"
          if [ "$TESTS_TOTAL" != "0" ]; then
            PASS_RATE=$(python3 -c "print(f'{(int(\"$TESTS_PASS\") / int(\"$TESTS_TOTAL\")) * 100:.0f}')" 2>/dev/null || echo "0")
          fi

          # Write summary
          cat >> $GITHUB_STEP_SUMMARY << 'HEADER_EOF'
          <div align="center">

          # AI Test Generation Pipeline

          **Automated test generation powered by AI for maximum code coverage**

          HEADER_EOF

          echo "${STATUS_ICON}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</div>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Repository details
          echo "### Repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **${REPO_NAME}** on branch \`${BRANCH}\` | Run [#${{ github.run_number }}](${RUN_URL}) | Triggered by **${{ github.actor }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Coverage section
          echo "### Coverage Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<table>" >> $GITHUB_STEP_SUMMARY
          echo "<tr>" >> $GITHUB_STEP_SUMMARY
          echo "<td width='50%'>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Final Coverage**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${BAR} ${COV_AFTER}%" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| | Before | After | Change |" >> $GITHUB_STEP_SUMMARY
          echo "|---|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Line Coverage** | ${COV_BEFORE}% | **${COV_AFTER}%** | ${COV_DELTA} pp |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</td>" >> $GITHUB_STEP_SUMMARY
          echo "<td width='50%'>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Quality Gates**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Threshold icons
          if [ "$THRESHOLD_OK" = "true" ]; then
            echo "| Check | Required | Actual | Result |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Coverage | >= ${MIN_COV}% | ${COV_AFTER}% | **PASSED** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Check | Required | Actual | Result |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Coverage | >= ${MIN_COV}% | ${COV_AFTER}% | **FAILED** |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$DELTA_OK" = "true" ]; then
            echo "| Delta | >= ${DELTA_REQ} pp | ${COV_DELTA} pp | **PASSED** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Delta | >= ${DELTA_REQ} pp | ${COV_DELTA} pp | **FAILED** |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</td>" >> $GITHUB_STEP_SUMMARY
          echo "</tr>" >> $GITHUB_STEP_SUMMARY
          echo "</table>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test results
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<table>" >> $GITHUB_STEP_SUMMARY
          echo "<tr>" >> $GITHUB_STEP_SUMMARY
          echo "<td align='center' width='25%'>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**${TESTS_GEN}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Files Generated" >> $GITHUB_STEP_SUMMARY
          echo "</td>" >> $GITHUB_STEP_SUMMARY
          echo "<td align='center' width='25%'>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**${TESTS_TOTAL}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Total Tests" >> $GITHUB_STEP_SUMMARY
          echo "</td>" >> $GITHUB_STEP_SUMMARY
          echo "<td align='center' width='25%'>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**${TESTS_PASS}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Passed" >> $GITHUB_STEP_SUMMARY
          echo "</td>" >> $GITHUB_STEP_SUMMARY
          echo "<td align='center' width='25%'>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**${TESTS_FAIL}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Failed" >> $GITHUB_STEP_SUMMARY
          echo "</td>" >> $GITHUB_STEP_SUMMARY
          echo "</tr>" >> $GITHUB_STEP_SUMMARY
          echo "</table>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$TESTS_TOTAL" != "0" ]; then
            echo "> **Pass Rate: ${PASS_RATE}%** of test cases passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Manual tests info
          if [ "$MANUAL_FOUND" = "true" ]; then
            echo "> Manual tests were detected and included in coverage measurement" >> $GITHUB_STEP_SUMMARY
          else
            echo "> No existing tests found â€” all tests were AI-generated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Generated Tests Branch section
          if [ "${{ inputs.auto_push_tests }}" = "true" ]; then
            echo "### Generated Tests" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.push-tests.outputs.tests_pushed }}" = "true" ]; then
              echo "> AI-generated tests have been pushed to branch \`${{ inputs.tests_branch || 'ai-generated-tests' }}\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "[View Branch](${{ steps.push-tests.outputs.tests_branch_url }}) | [Compare Changes](${{ steps.push-tests.outputs.compare_url }})" >> $GITHUB_STEP_SUMMARY
            elif [ "$THRESHOLD_OK" != "true" ]; then
              echo "> Tests were **not pushed** because coverage threshold was not met (${COV_AFTER}% < ${MIN_COV}%)" >> $GITHUB_STEP_SUMMARY
            else
              echo "> No new tests to push" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Links section
          echo "### Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Report | Link |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          if [ -n "$PAGES_URL" ]; then
            echo "| Coverage Report | [View Interactive Report](${PAGES_URL}) |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| Test Artifacts | [Download](${RUN_URL}#artifacts) |" >> $GITHUB_STEP_SUMMARY
          echo "| Generated Tests | \`generated-tests-${{ github.run_number }}\` artifact |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Footer
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<sub>Generated by **AI Test Generation Pipeline** | ${STATUS_TEXT}</sub>" >> $GITHUB_STEP_SUMMARY

      - name: Comment on Pull Request
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: ai-testgen-v2
          message: |
            <h2>AI Test Generation Pipeline</h2>

            <table>
            <tr>
            <td width="50%">

            **Coverage**

            | | Before | After | Delta |
            |---|:---:|:---:|:---:|
            | Line Coverage | ${{ steps.metrics.outputs.coverage_before }}% | **${{ steps.metrics.outputs.coverage_after }}%** | ${{ steps.metrics.outputs.coverage_delta }} pp |

            </td>
            <td width="50%">

            **Quality Gates**

            | Gate | Required | Actual | Status |
            |---|:---:|:---:|:---:|
            | Coverage | ${{ inputs.min_coverage || '90' }}% | ${{ steps.metrics.outputs.coverage_after }}% | ${{ steps.metrics.outputs.threshold_passed == 'true' && '**PASSED**' || '**FAILED**' }} |
            | Delta | ${{ inputs.delta_threshold || '0' }} pp | ${{ steps.metrics.outputs.coverage_delta }} pp | ${{ steps.metrics.outputs.delta_passed == 'true' && '**PASSED**' || '**FAILED**' }} |

            </td>
            </tr>
            </table>

            <details>
            <summary><strong>Test Details</strong> &mdash; ${{ steps.metrics.outputs.tests_generated }} files generated, ${{ steps.metrics.outputs.tests_passed }}/${{ steps.metrics.outputs.tests_total }} passed</summary>

            | Metric | Count |
            |--------|:-----:|
            | AI-Generated Test Files | ${{ steps.metrics.outputs.tests_generated }} |
            | Total Test Cases | ${{ steps.metrics.outputs.tests_total }} |
            | Passed | ${{ steps.metrics.outputs.tests_passed }} |
            | Failed | ${{ steps.metrics.outputs.tests_failed }} |

            </details>

            ${{ steps.deploy-pages.outputs.pages_url && format('[Coverage Report]({0})', steps.deploy-pages.outputs.pages_url) || '' }} | [Pipeline Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ${{ inputs.auto_push_tests == 'true' && steps.push-tests.outputs.tests_pushed == 'true' && format('| [Generated Tests]({0})', steps.push-tests.outputs.tests_branch_url) || '' }}

            ---
            <sub>Run #${{ github.run_number }} | ${{ steps.metrics.outputs.threshold_passed == 'true' && steps.metrics.outputs.delta_passed == 'true' && 'All quality gates passed' || 'Quality gates not met' }} | AI Test Generation Pipeline</sub>

      - name: Check Thresholds
        if: always()
        run: |
          THRESHOLD_PASSED="${{ steps.metrics.outputs.threshold_passed }}"
          DELTA_PASSED="${{ steps.metrics.outputs.delta_passed }}"

          if [ "$THRESHOLD_PASSED" != "true" ]; then
            echo "Coverage threshold not met!"
            echo "   Required: ${{ inputs.min_coverage || '90' }}%"
            echo "   Actual:   ${{ steps.metrics.outputs.coverage_after }}%"
            exit 1
          fi

          if [ "$DELTA_PASSED" != "true" ]; then
            echo "Delta threshold not met!"
            echo "   Required: >= ${{ inputs.delta_threshold || '0' }} pp improvement"
            echo "   Actual:   ${{ steps.metrics.outputs.coverage_delta }} pp"
            exit 1
          fi

          echo "All thresholds passed!"
